---
title: "对象锁与类锁"
discriptions: "对象锁与类锁"
date: 2018-11-30T06:38:14+08:00
author: Pismery Liu
archives: "2018"
tags: [concurrent,Java]
categories: [Java]
showtoc: true
---
<!--more-->


# 对象锁 vs 类锁

## 对象锁

> 介绍

在java中，对非静态方法和非静态代码块加synchronized表明对于每个对象实例最多只有一个线程能够访问此方法或代码块。用于保证实例对象级别的线程安全。

> 示例代码

```
public class Demo {
    public synchronized void method() {
        ...
    }
}


public class Demo {
    public void method() {
        synchronized(this) {
            ...
        }
    }
}


public class Demo {
    private final Object lock = new Object();
    
    public void method() {
        synchronized(lock) {
            ...
        }
    }
}

```

## 类锁

> 介绍

类锁避免了所有线程通过不同的实例进入代码块。即在某一时刻，系统有多个对象实例，只有一个线程通过其中一个实例访问代码块，其他实例和线程被阻塞。类锁用于保证静态属性的线程安全，因为静态属性是所有实例共享的。

> 示例代码

```
public class Demo {
    public synchronized static void method() {
        ...
    }
}


public class Demo {
    private final static Object lock = new Object();
    
    public void method() {
        synchornized(lock) {
            ...
        }
    }
}
```

> 关键点

1. synchronized关键字能够用于静态或非静态的方法和代码块，不能用于成员变量和构造函数。
2. 任何一个线程进入同步方法都需要获取锁，并在执行完同步方法或出现Error或者Exception后释放锁。
3.  synchronized是可重入的，即当一个线程已经获取锁，可以访问另一个需要相同锁的同步方法，而不需要重新获取锁。
4.  当“synchronized (lock)”中lock是null时，会抛出NPE
5.  synchronized很消耗性能，因此当必须要使用同步时，尽可能的缩小同步的范围。
6.  有可能静态同步方法和非静态同步方法会同时并发的跑，因为他们锁的对象不同。
7.  **不要同步一个非final的变量，最好用String变量，因为本身就是final不可变的**。
8.  当一个线程进入了同步方法，其他线程是能够访问非同步的方法。



> 使用同步非final示例

```
public class Demo {
    private Object lock = new Object();
    
    public void setObejct(Obejct lock) {
        this.lock = lock;
    }
    
    public void method() {
        synchornized(lock) {
            ....
        }
    }
    
    
    public static void main(String[] args) {
        thread1:run the method and get the lock;
        thread2:setObejct(new Object);
        thread2:run the method;(Although threa1 no release the lock, thread 2 will also get the new lock)
    }
}


```

# 参考链接

- [object-vs-class-level-locking](https://howtodoinjava.com/java/multi-threading/object-vs-class-level-locking/)
- [wait-notify-and-notifyall-methods](https://howtodoinjava.com/java/multi-threading/wait-notify-and-notifyall-methods/)
